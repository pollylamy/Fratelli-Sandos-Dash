<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FRATELLI SANDOS â€” Pizza Dash</title>
  <style>
    html, body { height:100%; margin:0; background:#fbad2a; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; color:#111; }
    .wrap { display:grid; grid-template-rows:auto 1fr auto; min-height:100%; }
    /* Header (logo only), larger logo */
    .site-header { display:flex; align-items:center; justify-content:center; padding:12px 12px; gap:12px; background:#fbad2a; }
    .site-header #brandLogo { height:84px; width:auto; object-fit:contain; border-radius:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .tools { display:none; }
    .brand, .title, .chip { display:none !important; }

    main { display:grid; place-items:center; padding:8px 12px 16px; }
    /* Stage wraps the game and positions HUD/controls in both desktop & mobile */
    .stage { position:relative; width:100%; display:grid; place-items:center; }
    /* Game canvas container: fixed 4:3 aspect, never wider than 920px, responsive */
    .game-shell { width:min(100vw - 24px, 920px); aspect-ratio:4/3; position:relative; border-radius:18px; padding:10px; background:#fff6f0; box-shadow:0 16px 48px rgba(0,0,0,.12), inset 0 1px 0 #fff; overflow:visible; }
    canvas { width:100%; height:100%; border-radius:14px; background:#fff; box-shadow:inset 0 0 0 1px #ececf3; display:block; touch-action:none; }
    /* Overlayed HUD for desktop */
    .hud { position:absolute; top:12px; left:14px; right:14px; display:flex; justify-content:space-between; align-items:center; pointer-events:none; }
    .score { background:rgba(255,255,255,.9); padding:6px 10px; border-radius:10px; font-weight:900; }
    .overlay { position:absolute; inset:10px; display:grid; place-items:center; z-index:10; }
    .overlay * { pointer-events:auto; }
    .card { background:#fff; border:1px solid #e8e8ef; border-radius:16px; padding:22px; text-align:center; max-width:620px; box-shadow:0 24px 72px rgba(0,0,0,.18); }
    .btn { pointer-events:auto; background:#ee2624; color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:900; cursor:pointer; box-shadow:0 6px 18px rgba(239,37,37,.25); }
    footer { text-align:center; padding:12px; font-size:12px; color:#6b7280; }

    /* Controls default (desktop overlay bottom-left) */
    .controls { position:absolute; left:12px; bottom:12px; display:flex; gap:8px; z-index:20; }
    .controls .btn-ctl { background:rgba(255,255,255,.95); border:1px solid #e8e8ef; border-radius:10px; width:44px; height:44px; font-weight:900; font-size:16px; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.15); }
    .controls .btn-ctl:active { transform: translateY(1px); }
    @media (max-width: 640px){ .controls .btn-ctl{ width:56px; height:56px; font-size:18px; } }

    /* Hide on-screen controls on desktop; keep on touch devices */
    @media (hover: hover) and (pointer: fine) { .controls { display:none; } }

    /* ---------- MOBILE LAYOUT (touch devices) ----------
       Keep canvas strict 4:3; move HUD above top-left; controls below;
       ensure everything fits the visible screen by shrinking the canvas
       using a max-height based on the dynamic viewport (100dvh).
    ---------------------------------------------------- */
    @media (hover: none) and (pointer: coarse) {
      /* Space for the HUD above the canvas */
      .stage { padding-top: 48px; }

      /* Limit canvas height so HUD and controls also fit on one screen */
      .game-shell {
        max-height: calc(100dvh - 300px); /* header + HUD + controls + footer */
      }

      /* Place HUD ABOVE the canvas at top-left (not covering) */
      .hud {
        position:absolute;
        top: auto; bottom: 100%;
        left: 0; right: auto;
        transform: none;
        margin-bottom: 8px;
        justify-content: flex-start;
        gap: 12px;
        pointer-events:auto;
      }
      .hud img#hudLogo { display:none; } /* tidy */

      /* Place controls below the canvas, centered */
      .controls {
        position: absolute;
        top: calc(100% + 56px);
        left: 50%;
        transform: translateX(-50%);
      }
    }

  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header (logo only) -->
    <header class="site-header">
      <img id="brandLogo" alt="Fratelli Sandos" />
      <div class="tools">
        <input id="logoUrl" placeholder="Paste logo URL" />
        <button class="btn" id="applyLogo">Apply</button>
      </div>
    </header>

    <main>
      <div class="stage">
        <div class="game-shell">
          <canvas id="game" width="900" height="675"></canvas>
          <div class="hud">
            <div id="score" class="score">Toppings: 0/0 â€¢ Lives: 3</div>
            <img id="hudLogo" style="height:28px;border-radius:6px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)"/>
          </div>
          <div id="overlay" class="overlay"></div>
        </div>
        <!-- Controls are positioned relative to .stage so they can sit *below* the canvas on phones -->
        <div class="controls" aria-label="On-screen controls">
          <button class="btn-ctl" data-code="ArrowUp"   aria-label="Up">â–²</button>
          <button class="btn-ctl" data-code="ArrowLeft" aria-label="Left">â—€</button>
          <button class="btn-ctl" data-code="ArrowRight" aria-label="Right">â–¶</button>
          <button class="btn-ctl" data-code="ArrowDown" aria-label="Down">â–¼</button>
        </div>
      </div>
    </main>

    <footer>
      Â© <span id="year"></span> FRATELLI SANDOS. Branded maze mini-game.
    </footer>
  </div>

  <script>
  (function(){
    // Basic guards
    var canvas = document.getElementById('game');
    var ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
    var overlay = document.getElementById('overlay');
    var scoreEl = document.getElementById('score');
    var brandLogo=document.getElementById('brandLogo');
    var hudLogo=document.getElementById('hudLogo');
    var logoUrlInput=document.getElementById('logoUrl');
    var applyLogoBtn=document.getElementById('applyLogo');
    document.getElementById('year').textContent=(new Date()).getFullYear();
    function setLogos(src){ if(!src) return; brandLogo.src=src; hudLogo.src=src; }

    // Default repo logo
    try { setLogos('assets/logo.png'); } catch(_) {}

    if(!ctx){
      if(overlay){
        var d=document.createElement('div'); d.className='card';
        d.innerHTML='<h2>Canvas not available</h2><p>Your browser cannot create a 2D canvas context.</p>';
        overlay.appendChild(d);
      }
      return;
    }

    // Game config
    var TILE=45, ROWS=15, COLS=20;
    var SPEED=3.0, ENEMY_SPEED=1.9;
    var VAN_SIZE={w:28,h:18};
    var START_TILE={r:1,c:1};
    var LIVES_MAX=3;
    var TOPPINGS=[{icon:'pepperoni'},{icon:'mushroom'},{icon:'cheese'},{icon:'tomato'}];
    var MAZE=[
      '11111111111111111111','10000000001000000001','10111101101011110101','10100001001010000101','10101111011010110101','10101000000010100101','10101011111010110101','10001010000010000101','11101010111111110101','10001010000000000101','10111011101111110101','10000000101000000101','10111110101011110101','10000000000000000001','11111111111111111111'
    ].map(function(r){return r.split('').map(function(c){return +c;});});

    // State
    var started=false, won=false, gameOver=false;
    var lives=LIVES_MAX;
    var player={x:0,y:0};
    var keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,KeyW:false,KeyA:false,KeyS:false,KeyD:false};
    var enemies=[]; var toppings=[]; var startTime=0, elapsed=0;

    // Helpers
    function toCenter(rc){ return {x: rc.c*TILE+TILE/2, y: rc.r*TILE+TILE/2}; }
    function isOpen(r,c){ return r>=0&&r<ROWS&&c>=0&&c<COLS&&MAZE[r][c]===0; }
    function tileAt(x,y){ var c=(x/TILE)|0, r=(y/TILE)|0; return {r:r,c:c,wall:!(isOpen(r,c))}; }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); }

    function resetPlayer(){ var ce=toCenter(START_TILE); player.x=ce.x; player.y=ce.y; }
    function placeToppings(n){ if(n===undefined) n=18; toppings=[]; var empties=[],r,c; for(r=1;r<ROWS-1;r++){ for(c=1;c<COLS-1;c++){ if(MAZE[r][c]===0) empties.push({r:r,c:c}); } } for(var i=empties.length-1;i>0;i--){ var j=(Math.random()*(i+1))|0; var t=empties[i]; empties[i]=empties[j]; empties[j]=t; } for(i=0;i<n;i++){ var p=empties[i]; var tt=TOPPINGS[(Math.random()*TOPPINGS.length)|0]; toppings.push({r:p.r,c:p.c,icon:tt.icon,collected:false}); } }
    function spawnEnemies(n){ if(n===undefined) n=1; enemies=[]; var sp=[{r:13,c:18},{r:8,c:10},{r:1,c:18},{r:12,c:2}]; for(var i=sp.length-1;i>0;i--){ var j=(Math.random()*(i+1))|0; var t=sp[i]; sp[i]=sp[j]; sp[j]=t; } var minManhattan=16; var far=sp.filter(function(s){ return Math.abs(s.r-START_TILE.r)+Math.abs(s.c-START_TILE.c) >= minManhattan; }); if(far.length < n){ sp.sort(function(a,b){ var da=Math.abs(a.r-START_TILE.r)+Math.abs(a.c-START_TILE.c); var db=Math.abs(b.r-START_TILE.r)+Math.abs(b.c-START_TILE.c); return db-da; }); far = sp; } for(i=0;i<n;i++){ var s=far[i]||sp[i]; var ce=toCenter(s); enemies.push({r:s.r,c:s.c,x:ce.x,y:ce.y,path:[]}); } }
    function updateScore(){ var got=toppings.filter(function(t){return t.collected;}).length; scoreEl.textContent='Toppings: '+got+'/'+toppings.length+' â€¢ Lives: '+lives; }
    function rectVsWall(nx,ny){ var hw=VAN_SIZE.w/2, hh=VAN_SIZE.h/2; var pts=[{x:nx-hw,y:ny-hh},{x:nx+hw,y:ny-hh},{x:nx-hw,y:ny+hh},{x:nx+hw,y:ny+hh}]; for(var i=0;i<pts.length;i++){ var t=tileAt(pts[i].x,pts[i].y); if(!t||t.wall) return true; } return false; }

    // Rendering
    function drawMaze(){
      for(var r=0;r<ROWS;r++){
        for(var c=0;c<COLS;c++){
          var x=c*TILE,y=r*TILE;
          if(MAZE[r][c]===1){
            ctx.fillStyle='#ee2624';
            ctx.fillRect(x+2,y+2,TILE-4,TILE-4);
            ctx.strokeStyle='rgba(251,173,42,.35)';
            ctx.strokeRect(x+2,y+2,TILE-4,TILE-4);
          } else {
            ctx.fillStyle='#ffe9e0';
            ctx.fillRect(x,y,TILE,TILE);
          }
        }
      }
    }
    function drawToppingIcon(icon,cx,cy){
      ctx.save(); ctx.translate(cx,cy);
      ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2);
      ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fill();
      ctx.shadowColor='rgba(0,0,0,0.25)'; ctx.shadowBlur=6; ctx.shadowOffsetY=1;
      if(icon==='pepperoni'){ ctx.beginPath(); ctx.arc(0,0,9,0,Math.PI*2); ctx.fillStyle='#9d1f1f'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#4a0f10'; ctx.stroke(); ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.fillStyle='#f7d7b8'; for(var i=0;i<6;i++){ ctx.beginPath(); ctx.arc(Math.cos(i*1.05)*3.5, Math.sin(i*1.33)*3.5, 1.3, 0, Math.PI*2); ctx.fill(); } }
      else if(icon==='mushroom'){ ctx.beginPath(); ctx.arc(0,0,10,Math.PI,0); ctx.fillStyle='#d8cdb8'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#8a7b66'; ctx.stroke(); ctx.fillStyle='#cdbfa6'; ctx.fillRect(-3,0,6,8); ctx.strokeStyle='#a4947d'; for(var g=-6; g<=6; g+=3){ ctx.beginPath(); ctx.moveTo(g,0); ctx.quadraticCurveTo(g/2,3, g,6); ctx.stroke(); } }
      else if(icon==='cheese'){ ctx.beginPath(); ctx.moveTo(-8,8); ctx.lineTo(10,0); ctx.lineTo(-8,-8); ctx.closePath(); ctx.fillStyle='#f1c232'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#b78b00'; ctx.stroke(); ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.fillStyle='#ffe08a'; for(var h=-4; h<=4; h+=4){ ctx.beginPath(); ctx.ellipse(h, (h%8===0)?-2:2, 1.4, 1, 0, 0, Math.PI*2); ctx.fill(); } }
      else if(icon==='tomato'){ ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fillStyle='#c62828'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#7a1010'; ctx.stroke(); ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.lineWidth=1.5; ctx.stroke(); ctx.fillStyle='#ffd9a6'; for(var k=0;k<6;k++){ ctx.beginPath(); ctx.ellipse(Math.cos(k*1.047)*4, Math.sin(k*1.047)*4,1.2,0.8,0,0,Math.PI*2); ctx.fill(); } }
      ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetY=0; ctx.restore();
    }
    function drawToppings(){ for(var i=0;i<toppings.length;i++){ var it=toppings[i]; if(it.collected) continue; var ce=toCenter(it); drawToppingIcon(it.icon, ce.x, ce.y); } }
    function drawVan(){ var w=VAN_SIZE.w,h=VAN_SIZE.h; var x=player.x-w/2,y=player.y-h/2; ctx.save(); ctx.fillStyle='#8d2023'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#ee2624'; ctx.fillRect(x,y-4,w*0.7,6); ctx.fillStyle='#1f2937'; ctx.beginPath(); ctx.arc(x+6,y+h,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+w-6,y+h,3,0,Math.PI*2); ctx.fill(); ctx.restore(); }
    function drawEnemies(){ for(var i=0;i<enemies.length;i++){ var e=enemies[i]; ctx.save(); ctx.translate(e.x, e.y); ctx.globalAlpha=0.15; ctx.beginPath(); ctx.ellipse(0,14,16,6,0,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill(); ctx.globalAlpha=1; ctx.fillStyle = '#111'; roundRect(ctx,-20,-12,40,24,4); ctx.fill(); ctx.fillStyle = '#d1e4ff'; roundRect(ctx,-4,-6,12,8,2); ctx.fill(); for(var a=-20;a<=20;a+=6){ ctx.fillStyle = (a/6)%2===0 ? '#fbad2a' : '#ee2624'; ctx.fillRect(a,-12,6,6); } ctx.fillStyle='#ffd558'; ctx.beginPath(); ctx.moveTo(-2,-16); ctx.lineTo(10,-12); ctx.lineTo(-2,-8); ctx.closePath(); ctx.fill(); ctx.fillStyle='#c62828'; for(var p=-1;p<=1;p++){ ctx.beginPath(); ctx.arc(3+p*3,-12,1.3,0,Math.PI*2); ctx.fill(); } var g=ctx.createLinearGradient(-10,0,18,0); g.addColorStop(0,'#fbad2a'); g.addColorStop(1,'#ee2624'); ctx.fillStyle=g; roundRect(ctx,-12,-2,24,6,2); ctx.fill(); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-14,12,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(14,12,3,0,Math.PI*2); ctx.fill(); ctx.restore(); } }
    function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawMaze(); drawToppings(); drawVan(); drawEnemies(); }

    function collectIfNear(){
      var hw=VAN_SIZE.w/2, hh=VAN_SIZE.h/2;
      for(var i=0;i<toppings.length;i++){
        var it=toppings[i]; if(it.collected) continue; var ce=toCenter(it);
        var dx=Math.abs(player.x-ce.x), dy=Math.abs(player.y-ce.y);
        if(dx<hw+6 && dy<hh+6){ it.collected=true; sfx('collect'); updateScore(); }
      }
      var all=toppings.every(function(t){return t.collected;});
      if(all && !won){ won=true; elapsed=(performance.now()-startTime)/1000; showWin(); sfx('win'); }
    }

    // Pathfinding
    function bfsPath(start,goal){
      var q=[start], prev={}, key=function(r,c){return r+','+c;};
      prev[key(start.r,start.c)]=null;
      var dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      while(q.length){
        var cur=q.shift();
        if(cur.r===goal.r&&cur.c===goal.c) break;
        for(var d=0; d<dirs.length; d++){
          var nr=cur.r+dirs[d][0], nc=cur.c+dirs[d][1];
          var k=key(nr,nc);
          if(isOpen(nr,nc) && !(k in prev)){
            prev[k]=cur; q.push({r:nr,c:nc});
          }
        }
      }
      var gk=key(goal.r,goal.c); if(!(gk in prev)) return [];
      var path=[], cc={r:goal.r,c:goal.c};
      while(cc){ path.push({r:cc.r,c:cc.c}); cc=prev[key(cc.r,cc.c)]; }
      path.reverse(); return path;
    }

    var pathTick=0;
    function enemyHitsPlayer(ex,ey){ var enemyHalf={x:20,y:12}; var vanHalf={x:VAN_SIZE.w/2,y:VAN_SIZE.h/2}; var dx=Math.abs(ex-player.x), dy=Math.abs(ey-player.y); return (dx < (enemyHalf.x+vanHalf.x-2)) && (dy < (enemyHalf.y+vanHalf.y-2)); }
    function updateEnemies(){
      var pr=(player.y/TILE)|0, pc=(player.x/TILE)|0;
      pathTick++;
      var recalc=(pathTick%12===0);
      for(var i=0;i<enemies.length;i++){
        var e=enemies[i];
        if(recalc || !e.path || e.path.length<=1){ e.path=bfsPath({r:e.r,c:e.c},{r:pr,c:pc}); }
        if(e.path && e.path.length>1){
          var next=e.path[1]; var ce=toCenter(next);
          var dx=ce.x-e.x, dy=ce.y-e.y; var len=Math.hypot(dx,dy)||1;
          e.x += ENEMY_SPEED*dx/len; e.y += ENEMY_SPEED*dy/len;
          if(Math.hypot(ce.x-e.x, ce.y-e.y)<1.5){ e.r=next.r; e.c=next.c; e.x=ce.x; e.y=ce.y; e.path.shift(); }
        }
        if(!gameOver && !won && enemyHitsPlayer(e.x,e.y)) playerHit();
      }
    }

    // Loop & UI
    function step(){
      var up=keys.ArrowUp||keys.KeyW, down=keys.KeyS||keys.ArrowDown, left=keys.KeyA||keys.ArrowLeft, right=keys.KeyD||keys.ArrowRight;
      var vx=0,vy=0; if(up)vy-=SPEED; if(down)vy+=SPEED; if(left)vx-=SPEED; if(right)vx+=SPEED; if(vx&&vy){ vx*=0.7071; vy*=0.7071; }
      var nx=clamp(player.x+vx, VAN_SIZE.w/2, COLS*TILE - VAN_SIZE.w/2); if(!rectVsWall(nx, player.y)) player.x=nx;
      var ny=clamp(player.y+vy, VAN_SIZE.h/2, ROWS*TILE - VAN_SIZE.h/2); if(!rectVsWall(player.x, ny)) player.y=ny;
      collectIfNear(); updateEnemies(); draw();
      if(started && !won && !gameOver) requestAnimationFrame(step);
    }
    function start(){ if(!started){ started=true; overlay.innerHTML=''; startTime=performance.now(); requestAnimationFrame(step); sfx('start'); } }
    function showStart(){ overlay.innerHTML=''; var d=document.createElement('div'); d.className='card'; d.innerHTML='<h2>Pizza Dash</h2><p>Collect all toppings, avoid the rival van. Press <b>Space</b> or tap <b>Start</b>.</p><button class="btn" id="go">Start</button>'; overlay.appendChild(d); var go=document.getElementById('go'); if(go){ go.onclick=start; try{ go.focus({preventScroll:true}); }catch(_){} } }
    function showWin(){ overlay.innerHTML=''; var d=document.createElement('div'); d.className='card'; d.innerHTML='<h2>All toppings collected! ðŸŽ‰</h2><p>Time: '+elapsed.toFixed(2)+'s</p><button class="btn" id="again">Play Again</button>'; overlay.appendChild(d); document.getElementById('again').onclick=function(){ reset(); start(); }; }
    function showLose(){ overlay.innerHTML=''; var d=document.createElement('div'); d.className='card'; d.innerHTML='<h2>Game Over</h2><p>You were caught!</p><button class="btn" id="retry">Try Again</button>'; overlay.appendChild(d); document.getElementById('retry').onclick=function(){ reset(); start(); }; }
    function playerHit(){ if (gameOver || won) return; lives--; sfx('hit'); if (lives <= 0) { gameOver = true; updateScore(); showLose(); } else { resetPlayer(); updateScore(); } }

    
// Optional audio samples (low-latency, preferred if present)
// Add these files to your repo under /assets/
var SAMPLES = {
  start:  'assets/lets-have-a-pizza-sando.mp3', // excited Italian male voice
  collect:'assets/coin.wav',                    // coin pickup
  hit:    'assets/oh_no.wav',                   // "oh no!" or similar
  win:    'assets/bravo.wav'                    // "bravo!" or short cheer
};


// --- SFX (samples + synth + TTS fallback) ---
var AC=null;
var sampleBuffers = {};  // name -> AudioBuffer

function getAC(){
  try {
    if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
    if(AC.state==='suspended' && AC.resume) AC.resume();
  } catch(_){}
  return AC;
}

// Load & decode a sample once, then cache
function loadSample(name, url){
  var ctx=getAC(); if(!ctx || !url) return Promise.resolve(null);
  if(sampleBuffers[name]) return Promise.resolve(sampleBuffers[name]);
  return fetch(url).then(r=>r.arrayBuffer())
    .then(ab=>ctx.decodeAudioData(ab))
    .then(buf => (sampleBuffers[name]=buf))
    .catch(()=>null);
}

// Fire & forget play
function playSample(name, gain){
  var ctx=getAC(); if(!ctx) return false;
  var buf=sampleBuffers[name]; if(!buf) return false;
  var src=ctx.createBufferSource(); src.buffer=buf;
  var g=ctx.createGain(); g.gain.value=(gain==null?0.9:gain);
  src.connect(g).connect(ctx.destination); src.start();
  return true;
}

// Simple synth helpers (arcade-y)
function tone(f,d,type,gain){
  var ctx=getAC(); if(!ctx) return;
  var o=ctx.createOscillator(), g=ctx.createGain();
  o.type=type||'square'; o.frequency.value=f;
  g.gain.value=(gain==null?0.08:gain);
  g.gain.setValueAtTime(g.gain.value, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + Math.max(0.03, d*0.9));
  o.connect(g).connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime + d);
}

// Cute arpeggio helper (for start/win)
function arp(freqs, stepMs){
  var t=0;
  freqs.forEach((f)=>{
    setTimeout(()=>tone(f,0.09,'square',0.12), t);
    t += stepMs;
  });
}

// TTS fallback (tries an Italian voice if available)
function say(text){
  try{
    if(!('speechSynthesis' in window)) return false;
    var u=new SpeechSynthesisUtterance(text);
    u.lang='it-IT';
    var vs=speechSynthesis.getVoices();
    var v = vs.find(v=>/it|ital/i.test(v.lang||'') && /male|luca|emanuele|paolo/i.test((v.name||''))) ||
            vs.find(v=>/it|ital/i.test(v.lang||'')) || null;
    if(v) u.voice=v;
    u.rate=1.0; u.pitch=1.0; u.volume=1.0;
    speechSynthesis.speak(u);
    return true;
  }catch(_){ return false; }
}

function sfx(kind){
  if(kind==='collect'){
    if(!playSample('collect',0.9)){
      tone(880, .05,'square',.12); setTimeout(()=>tone(1320,.05,'square',.10), 45);
    }
  }
  else if(kind==='hit'){
    if(!playSample('hit',0.9)){
      tone(330,.12,'sawtooth',.10); setTimeout(()=>tone(247,.14,'sawtooth',.10),110);
    }
  }
  else if(kind==='win'){
    if(!playSample('win',0.9)){
      arp([523,659,784,988,784,988], 120);
    }
  }
  else if(kind==='start'){
    var said = playSample('start', 0.95) || say("Let's have a pizza sando!!");
    arp([330,392,523,659], 90);
  }
}

// Preload samples (non-blocking)
(function preload(){
  try{
    Object.keys(SAMPLES||{}).forEach(name=>{
      var url=SAMPLES[name];
      if(url) loadSample(name, url);
    });
  }catch(_){}
})();


// Bind static controls    // Boot
    function reset(){ resetPlayer(); placeToppings(18); spawnEnemies(1); started=false; won=false; gameOver=false; lives=LIVES_MAX; updateScore(); draw(); }
    reset(); showStart();

    // Events
    window.addEventListener('keydown',function(e){
      if(e.code==='Space' || e.code==='Enter'){ start(); e.preventDefault(); }
      if(keys.hasOwnProperty(e.code)) keys[e.code]=true;
    });
    window.addEventListener('keyup',function(e){ if(keys.hasOwnProperty(e.code)) keys[e.code]=false; });
    applyLogoBtn && applyLogoBtn.addEventListener('click', function(){ var v=logoUrlInput.value && logoUrlInput.value.trim(); if(v) setLogos(v); });
    canvas.addEventListener('click', function(){ if(!started && !won && !gameOver) start(); });

    // Global error card
    window.addEventListener('error', function(e){
      try{
        var msg=(e&&e.message)?e.message:String(e);
        overlay.innerHTML='';
        var d=document.createElement('div'); d.className='card';
        d.innerHTML='<h3>Script error</h3><pre style="text-align:left;white-space:pre-wrap">'+msg+'</pre>';
        overlay.appendChild(d);
      }catch(_){}
    });
  })();
  </script>
</body>
</html>
